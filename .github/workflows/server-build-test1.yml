# updated this bullshit once again
name: Server - Build and Test

env:
  DOTNET_VERSION: '8.x'
  SOLUTION: Cobra.sln
  CONFIGURATION: Release

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
            
    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION }}
      
    - name: Build
      run: dotnet build --no-restore --configuration ${{ env.CONFIGURATION }} ${{ env.SOLUTION }}
      
    - name: Test
      run: dotnet test --no-build --verbosity normal ${{ env.SOLUTION }}

    - name: Cache
      uses: actions/cache@v4.2.4
      with:
        # A list of files, directories, and wildcard patterns to cache and restore
        path: 
        # An explicit key for restoring and saving the cache
        key: 
        # An ordered multiline string listing the prefix-matched keys, that are used for restoring stale cache if no cache hit occurred for key. Note `cache-hit` returns false in this case.
        restore-keys: # optional
        # The chunk size used to split up large files during upload, in bytes
        upload-chunk-size: # optional
        # An optional boolean when enabled, allows windows runners to save or restore caches that can be restored or saved respectively on other platforms
        enableCrossOsArchive: # optional, default is false
        # Fail the workflow if cache entry is not found
        fail-on-cache-miss: # optional, default is false
        # Check if a cache entry exists for the given input(s) (key, restore-keys) without downloading the cache
        lookup-only: # optional, default is false
        # Run the post step to save the cache even if another step before fails
        save-always: # optional, default is false
              
    - name: Upload a Build Artifact
      uses: actions/upload-artifact@v4.6.2
      with:
        # Artifact name
        name: # optional, default is artifact
        # A file, directory or wildcard pattern that describes what to upload
        path: 
        # The desired behavior if no files are found using the provided path.
        if-no-files-found: # optional, default is warn
        # Duration after which artifact will expire in days. 0 means using default retention.
        retention-days: # optional
        # The level of compression for Zlib to be applied to the artifact archive.
        compression-level: # optional, default is 6
        # If true, an artifact with a matching name will be deleted before a new one is uploaded.
        overwrite: # optional, default is false
        # If true, hidden files will be included in the artifact.
        include-hidden-files: # optional, default is false

